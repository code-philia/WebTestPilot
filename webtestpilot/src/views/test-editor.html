<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Test: {{TEST_NAME}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--vscode-foreground);
        }
        input[type="text"], input[type="url"], textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            box-sizing: border-box;
        }
        textarea {
            min-height: 60px;
            resize: vertical;
        }
        .actions-section {
            margin-top: 30px;
        }
        .action-item {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--vscode-editor-background);
        }
        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .action-number {
            font-weight: bold;
            color: var(--vscode-descriptionForeground);
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
        }
        .btn-primary {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        .btn-primary:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        .btn-secondary {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }
        .btn-secondary:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
        .btn-danger {
            background-color: var(--vscode-errorBackground);
            color: var(--vscode-button-foreground);
        }
        .btn-danger:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--vscode-panel-border);
            position: sticky;
            top: 0;
            background-color: var(--vscode-editor-background);
            z-index: 10;
        }
        .title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--vscode-foreground);
        }
        .button-group {
            display: flex;
            gap: 8px;
        }
        .action-item.compact {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
            background-color: var(--vscode-editor-background);
        }
        .action-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .action-row:last-child {
            margin-bottom: 0;
        }
        .action-number {
            font-weight: bold;
            color: var(--vscode-descriptionForeground);
            min-width: 20px;
            text-align: right;
        }
        .action-text.compact, .expected-result.compact {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            min-height: 24px;
        }
        .btn.compact {
            padding: 4px 8px;
            font-size: 12px;
            min-width: 24px;
            border-radius: 3px;
        }
        .btn-danger.compact {
            background-color: var(--vscode-errorBackground);
            color: var(--vscode-button-foreground);
            border: none;
        }
        .btn-danger.compact:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">Edit Test: {{TEST_NAME}}</div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="saveTest()">Save Test</button>
                <button class="btn btn-secondary" onclick="runTest()">Run Test</button>
                <button class="btn btn-secondary" onclick="closePanel()">Close</button>
            </div>
        </div>

        <div class="form-group">
            <label for="testName">Test Name:</label>
            <input type="text" id="testName" value="{{TEST_NAME_VALUE}}" />
        </div>

        <div class="form-group">
            <label for="testUrl">URL:</label>
            <input type="url" id="testUrl" value="{{TEST_URL_VALUE}}" placeholder="https://example.com" />
        </div>

        <div class="actions-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3>Actions</h3>
                <button class="btn btn-secondary" onclick="addAction()">Add Action</button>
            </div>
            
            <div id="actionsList">
                {{ACTIONS_LIST}}
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let actions = [];
        
        // Initialize actions from JSON data when DOM is ready
        function initializeActions() {
            console.log('Initializing actions...');
            
            // Try multiple methods to get actions
            let loadedActions = [];
            
            // Method 1: Try to get from JSON script element
            const actionsJsonElement = document.getElementById('actionsJson');
            if (actionsJsonElement) {
                try {
                    const parsedActions = JSON.parse(actionsJsonElement.textContent || '[]');
                    loadedActions = Array.isArray(parsedActions) ? parsedActions : [];
                    console.log('Method 1 - Loaded from JSON element:', loadedActions.length, 'items');
                } catch (e) {
                    console.error('Method 1 failed:', e);
                }
            } else {
                console.warn('Method 1 - actionsJson element not found');
            }
            
            // Method 2: Try to get from existing DOM elements
            if (loadedActions.length === 0) {
                const actionItems = document.querySelectorAll('.action-item');
                if (actionItems.length > 0) {
                    actionItems.forEach((item, index) => {
                        const actionInput = item.querySelector('.action-text');
                        const resultInput = item.querySelector('.expected-result');
                        
                        if (actionInput) {
                            loadedActions.push({
                                action: actionInput.value || '',
                                expectedResult: resultInput ? resultInput.value : ''
                            });
                        }
                    });
                    console.log('Method 2 - Loaded from DOM:', loadedActions.length, 'items');
                }
            }
            
            // Method 3: Check if there are any hardcoded actions in the page
            if (loadedActions.length === 0) {
                // Check if there are any action items already rendered
                const existingActions = document.querySelectorAll('.action-item');
                if (existingActions.length > 0) {
                    console.log('Method 3 - Found existing action items:', existingActions.length);
                    // Don't overwrite existing DOM content
                    return;
                }
            }
            
            actions = loadedActions;
            console.log('Final actions array:', actions);
            
            // Only render if we don't already have DOM content
            if (document.querySelectorAll('.action-item').length === 0) {
                renderActions();
            }
        }
        
        // Initialize when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeActions);
        } else {
            initializeActions();
        }
        
        function addAction() {
            actions.push({
                action: '',
                expectedResult: ''
            });
            renderActions();
        }
        
        function removeAction(index) {
            actions.splice(index, 1);
            renderActions();
        }
        
        function updateAction(index, field, value) {
            if (actions[index]) {
                actions[index][field] = value;
            }
        }
        
        function saveTest() {
            const name = document.getElementById('testName').value.trim();
            const url = document.getElementById('testUrl').value.trim();
            
            if (!name) {
                vscode.postMessage({
                    command: 'showError',
                    text: 'Test name is required'
                });
                return;
            }
            
            // Ensure actions are up-to-date from DOM
            syncActionsFromDOM();
            
            console.log('Saving test with actions:', actions);
            
            vscode.postMessage({
                command: 'save',
                data: {
                    name,
                    url,
                    actions
                }
            });
        }
        
        function syncActionsFromDOM() {
            const actionItems = document.querySelectorAll('.action-item');
            const syncedActions = [];
            
            actionItems.forEach((item, index) => {
                const actionInput = item.querySelector('.action-text');
                const resultInput = item.querySelector('.expected-result');
                
                if (actionInput) {
                    syncedActions.push({
                        action: actionInput.value || '',
                        expectedResult: resultInput ? resultInput.value : ''
                    });
                }
            });
            
            actions = syncedActions;
            console.log('Synced actions from DOM:', actions);
        }
        
        function closePanel() {
            vscode.postMessage({
                command: 'close'
            });
        }
        
        function runTest() {
            console.log('runTest called, actions:', actions);
            console.log('actions length:', actions ? actions.length : 'null/undefined');
            
            // Validate actions before running
            if (!actions || actions.length === 0) {
                console.error('No actions found, showing error');
                vscode.postMessage({
                    command: 'showError',
                    text: 'Cannot run test: No actions defined. Please add test actions before running.'
                });
                return;
            }
            
            // Check if all actions have content
            const hasEmptyActions = actions.some(action => 
                !action.action || action.action.trim() === ''
            );
            
            if (hasEmptyActions) {
                vscode.postMessage({
                    command: 'showError', 
                    text: 'Cannot run test: Some actions are empty. Please fill in all action descriptions.'
                });
                return;
            }
            
            console.log('Validation passed, saving and running test');
            // First save the test, then run it
            saveTest();
            setTimeout(() => {
                vscode.postMessage({
                    command: 'runTest'
                });
            }, 500);
        }
        
        function renderActions() {
            const container = document.getElementById('actionsList');
            
            console.log('renderActions called with:', actions);
            
            if (!actions || actions.length === 0) {
                container.innerHTML = '<div class="empty-state">No actions defined. Click "Add Action" to get started.</div>';
                return;
            }
            
            container.innerHTML = actions.map((action, index) => `
                <div class="action-item compact" data-index="${index}">
                    <div class="action-row">
                        <span class="action-number">${index + 1}.</span>
                        <input type="text" class="action-text compact" placeholder="Action" 
                               value="${escapeHtml(action.action || '')}" 
                               onchange="updateAction(${index}, 'action', this.value)">
                        <button class="btn btn-danger compact" onclick="removeAction(${index})">×</button>
                    </div>
                    <div class="action-row">
                        <span class="action-number">→</span>
                        <input type="text" class="expected-result compact" placeholder="Expected result" 
                               value="${escapeHtml(action.expectedResult || '')}" 
                               onchange="updateAction(${index}, 'expectedResult', this.value)">
                        </div>
                </div>
            `).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Auto-save on input changes
        document.getElementById('testName').addEventListener('input', function() {
            vscode.postMessage({
                command: 'updateTest',
                data: {
                    name: this.value.trim()
                }
            });
        });
        
        document.getElementById('testUrl').addEventListener('input', function() {
            vscode.postMessage({
                command: 'updateTest',
                data: {
                    url: this.value.trim()
                }
            });
        });
    </script>
</body>
</html>