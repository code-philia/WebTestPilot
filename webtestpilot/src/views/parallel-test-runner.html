<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parallel Tests: {{FOLDER_NAME}}</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            margin: 0;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--vscode-editor-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 8px;
        }

        .header h1 {
            margin: 0 0 10px 0;
            color: var(--vscode-foreground);
        }

        .controls {
            margin: 20px 0;
            text-align: center;
        }

        .btn {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            font-family: var(--vscode-font-family);
        }

        .btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .btn:disabled {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            cursor: not-allowed;
        }

        .btn.danger {
            background-color: var(--vscode-errorBackground);
            color: var(--vscode-errorForeground);
        }

        .btn.danger:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .test-card {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 8px;
            padding: 15px;
            background-color: var(--vscode-editor-background);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .test-name {
            font-weight: bold;
            color: var(--vscode-foreground);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .test-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-running {
            color: var(--vscode-testing-runIcon, #007acc);
        }

        .status-stopped {
            color: var(--vscode-warningBackground, #ffc107);
        }

        .status-passed {
            color: var(--vscode-testing-passedIcon, #28a745);
        }

        .status-failed {
            color: var(--vscode-testing-failedIcon, #dc3545);
        }

        .status-pending {
            background-color: var(--vscode-descriptionForeground);
            color: var(--vscode-editor-background);
        }

        .test-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--vscode-descriptionForeground);
        }

        .test-screenshot {
            width: 100%;
            height: 200px;
            background-color: var(--vscode-editor-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .test-actions {
            display: flex;
            gap: 5px;
        }

        .test-actions .btn {
            font-size: 11px;
            padding: 4px 8px;
        }


        .summary {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background-color: var(--vscode-editor-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 8px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-number {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }

        .summary-label {
            font-size: 12px;
            color: var(--vscode-descriptionForeground);
        }

        .error-details {
            margin-top: 10px;
            padding: 8px;
            background-color: var(--vscode-inputValidation-errorBackground);
            border: 1px solid var(--vscode-inputValidation-errorBorder);
            border-radius: 4px;
            font-size: 11px;
            color: var(--vscode-errorForeground);
            max-height: 60px;
            overflow-y: auto;
        }

            .url-info {
                font-size: 11px;
                color: var(--vscode-descriptionForeground);
                margin-bottom: 2px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .tab-info {
                font-size: 10px;
                color: var(--vscode-charts-blue);
                margin-bottom: 5px;
                font-weight: bold;
            }

            .log-container {
                max-height: 150px;
                overflow-y: auto;
                background-color: var(--vscode-editor-background);
                border: 1px solid var(--vscode-panel-border);
                border-radius: 4px;
                padding: 8px;
                margin-top: 10px;
                font-family: var(--vscode-editor-font-family);
                font-size: 11px;
                line-height: 1.4;
            }

            .log-entry {
                margin-bottom: 2px;
                word-wrap: break-word;
            }

            .log-time {
                color: var(--vscode-descriptionForeground);
                font-weight: bold;
            }

            .log-type {
                color: var(--vscode-charts-blue);
                font-weight: bold;
                margin-left: 5px;
            }

            .log-message {
                color: var(--vscode-foreground);
                margin-left: 5px;
            }

            .log-stderr .log-type {
                color: var(--vscode-errorForeground);
            }

            .log-stderr .log-message {
                color: var(--vscode-errorForeground);
            }
    </style>
</head>
<body>
    <div class="header">
        <h1>Parallel Tests: {{FOLDER_NAME}}</h1>
        <div id="connectionStatus">Connecting to browser...</div>
    </div>

    <div class="summary" id="summary" style="display: none;">
        <div class="summary-item">
            <span class="summary-number" id="totalTests">0</span>
            <span class="summary-label">Total Tests</span>
        </div>
        <div class="summary-item">
            <span class="summary-number" id="runningTests">0</span>
            <span class="summary-label">Running</span>
        </div>
        <div class="summary-item">
            <span class="summary-number" id="passedTests">0</span>
            <span class="summary-label">Passed</span>
        </div>
        <div class="summary-item">
            <span class="summary-number" id="failedTests">0</span>
            <span class="summary-label">Failed</span>
        </div>
        <div class="summary-item">
            <span class="summary-number" id="stoppedTests">0</span>
            <span class="summary-label">Stopped</span>
        </div>
    </div>

    <div class="controls">
        <button class="btn danger" id="stopAllBtn" onclick="stopAllTests()" disabled>Stop All Tests</button>
        <button class="btn" id="clearFinishedBtn" onclick="clearFinished()" disabled>Clear Finished</button>
        <button class="btn danger" id="clearTabsBtn" onclick="clearTabs()">Clear All Tabs</button>
    </div>

    <div id="testGrid" class="test-grid"></div>

    <script>
        const vscode = acquireVsCodeApi();
        let tests = new Map();
        let totalTestCount = 0;

        // Notify VS Code that we're ready
        window.addEventListener('load', () => {
            vscode.postMessage({ type: 'ready' });
        });

        // Handle messages from VS Code
        window.addEventListener('message', event => {
            const message = event.data;

            switch (message.type) {
                case 'connected':
                    document.getElementById('connectionStatus').textContent = 
                        `‚úÖ Connected to browser - Ready to run tests in "${message.folderName}"`;
                    break;

                case 'testStarted':
                    handleTestStarted(message);
                    break;

                case 'testFinished':
                    handleTestFinished(message);
                    break;

                case 'screenshot':
                    handleScreenshot(message);
                    break;

                case 'logMessage':
                    handleLogMessage(message);
                    break;

                case 'viewLogs':
                    // VS Code will handle opening the individual test output channel
                    break;

                case 'tabsCleared':
                    // Clear all test cards and reset state
                    const grid = document.getElementById('testGrid');
                    grid.innerHTML = '';
                    tests.clear();
                    totalTestCount = 0;
                    updateSummary();
                    document.getElementById('clearFinishedBtn').disabled = true;
                    break;

                case 'stepUpdate':
                    handleStepUpdate(message);
                    break;

                case 'streamingStopped':
                    // Update UI to show streaming has stopped
                    const urlElement = document.getElementById(`url-${message.testId}`);
                    if (urlElement) {
                        const test = tests.get(message.testId);
                        if (test) {
                            urlElement.textContent = `Tab #${test.tabIndex || '?'}: Streaming stopped`;
                            urlElement.style.color = 'var(--vscode-descriptionForeground)';
                        }
                    }
                    break;

                case 'error':
                    document.getElementById('connectionStatus').textContent = 
                        `‚ùå Connection failed: ${message.message}`;
                    break;
            }
        });

        function handleTestStarted(message) {
            const testId = message.testId;
            const testName = message.testName;
            const url = message.url;
            const tabIndex = message.tabIndex;
            const totalSteps = message.totalSteps || 0;

            const test = {
                id: testId,
                name: testName,
                url: url,
                tabIndex: tabIndex,
                status: 'running',
                startTime: Date.now(),
                endTime: null,
                duration: null,
                result: null,
                currentStep: 0,
                totalSteps: totalSteps
            };

            tests.set(testId, test);
            totalTestCount++;
            
            createTestCard(test);
            updateSummary();
            
            document.getElementById('stopAllBtn').disabled = false;
        }

        function handleTestFinished(message) {
            const testId = message.testId;
            const result = message.result;
            const duration = message.duration;

            const test = tests.get(testId);
            if (test) {
                test.status = result.success ? 'passed' : 'failed';
                test.endTime = Date.now();
                test.duration = duration;
                test.result = result;

                updateTestCard(test);
                updateSummary();
            }

            // Check if all tests are finished
            const allFinished = Array.from(tests.values()).every(t => 
                t.status === 'passed' || t.status === 'failed' || t.status === 'stopped'
            );

            if (allFinished) {
                document.getElementById('stopAllBtn').disabled = true;
                document.getElementById('clearFinishedBtn').disabled = false;
            }
        }

        function handleScreenshot(message) {
            const testId = message.testId;
            const data = message.data;
            const timestamp = message.timestamp;
            const url = message.url;

            const imgElement = document.getElementById(`screenshot-${testId}`);
            if (imgElement) {
                imgElement.src = `data:image/png;base64,${data}`;
                
                // Update URL info to show current page URL
                const urlElement = document.getElementById(`url-${testId}`);
                if (urlElement && url) {
                    urlElement.textContent = `Tab #${tests.get(testId)?.tabIndex || '?'}: ${url}`;
                    urlElement.title = url;
                }
                
                // Update last screenshot timestamp
                const timeElement = document.getElementById(`last-update-${testId}`);
                if (timeElement && timestamp) {
                    const time = new Date(timestamp);
                    timeElement.textContent = `Last update: ${time.toLocaleTimeString()}`;
                }
            }
        }

        function handleStepUpdate(message) {
            const testId = message.testId;
            const stepNumber = message.stepNumber;
            const status = message.status;
            const stepMessage = message.message;
            const error = message.error;

            const test = tests.get(testId);
            if (!test) return;

            // Update current step
            test.currentStep = stepNumber;

            // Update step counter display
            const stepsElement = document.getElementById(`steps-${testId}`);
            if (stepsElement) {
                const totalSteps = test.totalSteps > 0 ? test.totalSteps : Math.max(stepNumber, 5);
                stepsElement.textContent = `${stepNumber}/${totalSteps}`;
            }

            // Add step update to log with appropriate styling
            const logContainer = document.getElementById(`log-container-${testId}`);
            if (logContainer) {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-step-${status}`;
                
                const time = new Date().toLocaleTimeString();
                let icon = '';
                let logClass = '';
                
                switch (status) {
                    case 'executing':
                        icon = '‚ñ∂Ô∏è';
                        logClass = 'log-step-executing';
                        break;
                    case 'passed':
                        icon = '‚úÖ';
                        logClass = 'log-step-passed';
                        break;
                    case 'failed':
                        icon = '‚ùå';
                        logClass = 'log-step-failed';
                        break;
                    case 'verifying':
                        icon = 'üîç';
                        logClass = 'log-step-verifying';
                        break;
                    case 'completed':
                        icon = '‚úÖ';
                        logClass = 'log-step-completed';
                        break;
                }
                
                logEntry.innerHTML = `
                    <span class="log-time">[${time}]</span>
                    <span class="log-type ${logClass}">${icon} STEP ${stepNumber}:</span>
                    <span class="log-message">${stepMessage}</span>
                `;
                
                logContainer.appendChild(logEntry);
                
                // Auto-scroll to bottom
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Limit log entries to prevent memory issues
                const maxEntries = 100;
                while (logContainer.children.length > maxEntries) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }

            // Show error details if step failed
            if (status === 'failed' && error) {
                const errorElement = document.getElementById(`error-${testId}`);
                if (errorElement) {
                    errorElement.textContent = `Step ${stepNumber} failed: ${error}`;
                    errorElement.style.display = 'block';
                }
            }
        }

        function handleLogMessage(message) {
            const testId = message.testId;
            const logType = message.logType;
            const logMessage = message.message;
            const logContainer = document.getElementById(`log-container-${testId}`);

            if (logContainer) {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${logType}`;
                logEntry.innerHTML = `
                    <span class="log-type">${logType.toUpperCase()}:</span>
                    <span class="log-message">${logMessage}</span>
                `;
                
                logContainer.appendChild(logEntry);
                
                // Auto-scroll to bottom
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Limit log entries to prevent memory issues
                const maxEntries = 1000;
                while (logContainer.children.length > maxEntries) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }

            // Update step counter based on step information in logs (fallback for cases where stepUpdate messages might be missed)
            updateStepCounter(testId, logMessage);
        }

        function updateStepCounter(testId, logMessage) {
            // Match patterns like "STEP_1_PASSED", "STEP_2", "STEP 2", "Step 2", etc.
            const stepMatch = logMessage.match(/STEP[_\s]*(\d+)(?:_[A-Z]+)?/i);
            if (stepMatch) {
                const currentStep = parseInt(stepMatch[1]);
                const test = tests.get(testId);
                
                if (test) {
                    // Use the total steps provided from the backend
                    const totalSteps = test.totalSteps > 0 ? test.totalSteps : Math.max(currentStep, 5);
                    
                    // Update step counter display
                    const stepsElement = document.getElementById(`steps-${testId}`);
                    if (stepsElement) {
                        stepsElement.textContent = `${currentStep}/${totalSteps}`;
                    }
                    
                    // Store current step
                    test.currentStep = currentStep;
                }
            }
        }

        function createTestCard(test) {
            const grid = document.getElementById('testGrid');
            
            const card = document.createElement('div');
            card.className = 'test-card';
            card.id = `test-card-${test.id}`;
            
            card.innerHTML = `
                <div class="test-header">
                    <div class="test-name" title="${test.name}">${test.name}</div>
                    <div class="test-status status-${test.status}" id="status-${test.id}">${test.status}</div>
                </div>
                <div class="url-info" title="${test.url || 'No URL'}">${test.url || 'No URL'}</div>
                <div class="url-info tab-info" id="url-${test.id}" title="Browser tab index">Tab #${test.tabIndex || '?'}</div>
                <div class="test-info">
                    <span id="duration-${test.id}">Starting...</span>
                    <span id="steps-${test.id}">${test.totalSteps > 0 ? `0/${test.totalSteps}` : '-'}</span>
                    <span id="last-update-${test.id}" title="Last screenshot update">Waiting...</span>
                </div>
                <img class="test-screenshot" id="screenshot-${test.id}" alt="Test screenshot">
                <div class="test-actions">
                    <button class="btn" onclick="stopTest('${test.id}')" id="stop-btn-${test.id}">Stop</button>
                    <button class="btn btn-secondary" onclick="viewLogs('${test.id}', '${test.name.replace(/'/g, "\\'")}')">View Logs</button>
                    <button class="btn btn-secondary" onclick="toggleLogs('${test.id}')">Hide Logs</button>
                </div>
                <div class="log-container" id="log-container-${test.id}" style="display: block;"></div>
                <div class="error-details" id="error-${test.id}" style="display: none;"></div>
            `;
            
            grid.appendChild(card);

            // Start duration timer
            updateDuration(test.id);
        }

        function updateTestCard(test) {
            const statusElement = document.getElementById(`status-${test.id}`);
            const durationElement = document.getElementById(`duration-${test.id}`);
            const stepsElement = document.getElementById(`steps-${test.id}`);
            const stopBtn = document.getElementById(`stop-btn-${test.id}`);
            const errorElement = document.getElementById(`error-${test.id}`);
            const progressElement = document.getElementById(`progress-${test.id}`);

            if (statusElement) {
                statusElement.className = `test-status status-${test.status}`;
                statusElement.textContent = test.status;
            }

            if (durationElement) {
                durationElement.textContent = formatDuration(test.duration);
            }

            if (stepsElement) {
                if (test.currentStep && test.totalSteps) {
                    stepsElement.textContent = `${test.currentStep}/${test.totalSteps}`;
                } else if (test.result) {
                    stepsElement.textContent = `${test.result.stepsExecuted} steps`;
                }
            }

            if (stopBtn) {
                stopBtn.style.display = 'none';
            }

            if (errorElement && test.result && test.result.errors && test.result.errors.length > 0) {
                errorElement.textContent = test.result.errors.join('\n');
                errorElement.style.display = 'block';
            }
        }

        function updateDuration(testId) {
            const test = tests.get(testId);
            if (!test || test.status !== 'running') return;

            const durationElement = document.getElementById(`duration-${testId}`);
            if (durationElement) {
                const elapsed = Date.now() - test.startTime;
                durationElement.textContent = formatDuration(elapsed);
            }

            setTimeout(() => updateDuration(testId), 1000);
        }

        function formatDuration(ms) {
            if (ms < 1000) return `${ms}ms`;
            if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
            return `${(ms / 60000).toFixed(1)}m`;
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            const running = Array.from(tests.values()).filter(t => t.status === 'running').length;
            const passed = Array.from(tests.values()).filter(t => t.status === 'passed').length;
            const failed = Array.from(tests.values()).filter(t => t.status === 'failed').length;
            const stopped = Array.from(tests.values()).filter(t => t.status === 'stopped').length;

            document.getElementById('totalTests').textContent = totalTestCount;
            document.getElementById('runningTests').textContent = running;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('stoppedTests').textContent = stopped;

            summary.style.display = 'flex';
        }

        function stopTest(testId) {
            vscode.postMessage({
                type: 'stopTest',
                testId: testId
            });

            const test = tests.get(testId);
            if (test) {
                test.status = 'stopped';
                updateTestCard(test);
                updateSummary();
            }
        }

        function toggleLogs(testId) {
            const logContainer = document.getElementById(`log-container-${testId}`);
            const toggleBtn = document.querySelector(`button[onclick="toggleLogs('${testId}')"]`);
            
            if (logContainer && toggleBtn) {
                const isVisible = logContainer.style.display !== 'none';
                logContainer.style.display = isVisible ? 'none' : 'block';
                toggleBtn.textContent = isVisible ? 'Show Logs' : 'Hide Logs';
            }
        }

        function viewLogs(testId, testName) {
            vscode.postMessage({
                type: 'viewLogs',
                testId: testId,
                testName: testName
            });
        }

        function stopAllTests() {
            vscode.postMessage({ type: 'stopAll' });
            
            // Update UI immediately for better UX
            for (const test of tests.values()) {
                if (test.status === 'running') {
                    test.status = 'stopped';
                    updateTestCard(test);
                }
            }
            updateSummary();
        }

        function clearFinished() {
            const grid = document.getElementById('testGrid');
            const cards = grid.querySelectorAll('.test-card');
            
            cards.forEach(card => {
                const testId = card.id.replace('test-card-', '');
                const test = tests.get(testId);
                
                if (test && (test.status === 'passed' || test.status === 'failed' || test.status === 'stopped')) {
                    card.remove();
                    tests.delete(testId);
                }
            });

            // Reset counters if all tests are cleared
            if (tests.size === 0) {
                totalTestCount = 0;
                updateSummary();
                document.getElementById('clearFinishedBtn').disabled = true;
            }
        }

        function clearTabs() {
            vscode.postMessage({ type: 'confirmClearTabs' });
        }
    </script>
</body>
</html>